'use strict';

angular.module('d3', [])
  .factory('d3Service', ['$document', '$q', '$rootScope',
    function($document, $q, $rootScope) {
      var d = $q.defer();
      function onScriptLoad() {
        // Load client in the browser
        $rootScope.$apply(function() { d.resolve(window.d3); });
      };

      var scriptTag = $document[0].createElement('script');
      scriptTag.type = 'text/javascript';
      scriptTag.async = true;
      scriptTag.src = 'http://d3js.org/d3.v4.min.js';
      scriptTag.onreadystatechange = function () {
        if (this.readyState == 'complete') onScriptLoad();
      };
      scriptTag.onload = onScriptLoad;

      var s = $document[0].getElementsByTagName('body')[0];
      s.appendChild(scriptTag);
      return {
        d3: function() { return d.promise; }
      };
}]);


var module = angular.module('app', ['d3']);
module.config(function($locationProvider) {
  $locationProvider.html5Mode(true);
});
module.service('StockService', StockService);
module.controller('myController', myController);

function myController(StockService, $scope) {
  var model = this;
  var companyNames = [];
  var company = {};
  model.companiesNames = ['CSCO', 'MSFT', 'ADBE'];

  model.showCompany = function(name){
    if(!!company[name]){
      model.company = company[name];
      return;
    }
    company[name] = [];
    StockService.getCompanyDate(name).then(function(response){
      var data=response.quote;
      angular.forEach(data, function(value) {
        value.Date = new Date(value.Date.split('-').join(','));
        company[name].push(value);
        model.companyNames = companyNames;
        model.company = company[name];

      });
    }, function(error){
      alert(error);
    });
  };
};


function StockService($http, $q) {
  var domain = "http://query.yahooapis.com/v1/public/yql?q=";
  var query = "&format=json&diagnostics=true&env=http://datatables.org/alltables.env";

  return {
    getCompanyDate: function(name){
      var url = domain +
      encodeURI("select * from yahoo.finance.historicaldata where symbol in('"
       + name +
       "')and startDate = '2016-01-01' and endDate = '2016-06-30'") +
      query;

      var deferred = $q.defer();
      $http.get(url).then(function(response) {
        var date = angular.fromJson(response.data.query.results);
        deferred.resolve(date);
      }, function(error) {
        deferred.reject({ message: 'Problem with connection' });
      });
      return deferred.promise;
    }
  };
}

'use strict';

angular.module('app').directive('chart', ['d3Service', function(d3Service) {
  return {
    restrict: 'E',
    scope: {
      item: '=ngModel'
    },
    link: function(scope, element, iAttrs) {

      var item;

      function getDate(date) {
        return new Date(date);
      }
      d3Service.d3().then(function(d3) {


        scope.$watch('item', function(nVal) {
          if (!!nVal) {
            var svg;
            d3.select("#ID").remove();



            var data = angular.copy(nVal).reverse();

            var margin = { top: 20, right: 20, bottom: 410, left: 50 },
              margin2 = { top: 430, right: 20, bottom: 330, left: 50 },
              margin3 = { top: 500, right: 20, bottom: 40, left: 50 },
              width = 1200 - margin.left - margin.right,
              height = 800 - margin.top - margin.bottom,
              height2 = 800 - margin2.top - margin2.bottom,
              height3 = 800 - margin3.top - margin3.bottom;


            var x = d3.scaleTime().range([0, width]),
              x2 = d3.scaleTime().range([0, width]),
              //x3 = d3.scaleTime().rangeRound([0, width]),
              x3 = d3.scaleBand().rangeRound([0, width]).padding(0.1).align(0.1),
              y = d3.scaleLinear().range([height, 0]),
              y2 = d3.scaleLinear().range([height2, 0]),
              y3 = d3.scaleLinear().range([height3, 0]);

            var xAxis = d3.axisBottom(x),
              xAxis2 = d3.axisBottom(x2),
              xAxis3 = d3.axisBottom(x3).tickFormat(d3.timeFormat("%m-%d")),
              yAxis = d3.axisLeft(y),
              yAxis3 = d3.axisLeft(y3);

            var brush = d3.brushX()
              .extent([
                [0, 0],
                [width, height2]
              ])
              .on("brush", brushed);

            svg = d3.select(element[0]).append("svg")
              .attr("id", "ID")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom);

            svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height);

            var focus = svg.append("g")
              .attr("class", "focus")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var context = svg.append("g")
              .attr("class", "context")
              .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

            var freg = svg.append("g")
              .attr("class", "freg")
              .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");




            x.domain(d3.extent(data, function(d) {
              return d.Date;
            }));
            y.domain([d3.min(data, function(d) {
              return d.Low;
            }), d3.max(data, function(d) {
              return d.High;
            })]);
            x2.domain(x.domain());
            y2.domain(y.domain());
            //x3.domain(x.domain());
            x3.domain(data.map(function(d) {
              return d.Date;
            }));

            y3.domain(y.domain());


            var area = d3.area()
              .curve(d3.curveMonotoneX)
              .x(function(d) {
                return x(d.Date);
              })
              .y0(height)
              .y1(function(d) {
                return y(d.Close);
              });

            focus.append("path")
              .data([data])
              .attr("class", "area")
              .attr("d", area);


            // append scatter plot to main chart area
            var dots = focus.append("g");
            dots.attr("clip-path", "url(#clip)");
            dots.selectAll("dot")
              .data(data)
              .enter().append("circle")
              .attr('class', 'dot')
              .attr("r", 3)
              .style("opacity", .5)
              .attr("cx", function(d) {
                return x(d.Date);
              })
              .attr("cy", function(d) {
                return y(d.Close);
              })
              .on('mouseover', function(d) {
                d3.select(this).attr('r', 7);

                var formatTime = d3.timeFormat("%e %B")


                div.html(
                    '<table>' + '<tr>' +
                    '<td>' + 'Date' + '</td>' +
                    '<td>' + formatTime(d.Date) + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Open' + '</td>' +
                    '<td>' + d.Open + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Close' + '</td>' +
                    '<td>' + d.Close + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'High' + '</td>' +
                    '<td>' + d.High + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Low' + '</td>' +
                    '<td>' + d.Low + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Volume' + '</td>' +
                    '<td>' + d.Volume + '</td>' + '</tr>' + '</table>'
                  )
                  .style("left", (d3.event.pageX) + "px")
                  .style("top", (d3.event.pageY - parseInt(div.style('height'), 10)) + "px")
                  .transition()
                  .duration(200)
                  .style("opacity", .9)
              })
              .on('mouseout', function(d) {
                d3.select(this).attr('r', 3);
                div.transition()
                  .duration(500)
                  .style("opacity", 0);
              });

            focus.append("g")
              .attr("class", "axis axis--x")
              .attr("fill", "none")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

            focus.append("g")
              .attr("class", "axis axis--y")
              .call(yAxis);

            focus.append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left)
              .attr("x", 0 - (height / 2))
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .text("Price");

            svg.append("text")
              .attr("transform",
                "translate(" + ((width + margin.right + margin.left) / 2) + " ," +
                margin3.top + ")")
              .style("text-anchor", "middle")
              .text("Date");

            // Define the div for the tooltip
            var div = d3.select(element[0]).append("div")
              .attr("class", "tooltip")
              .style("opacity", 0);



            // append scatter plot to brush chart area
            context.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height2 + ")")
              .call(xAxis2);

            context.append("g")
              .attr("class", "brush")
              .call(brush)
              .call(brush.move, x.range());

            var area2 = d3.area()
              .curve(d3.curveMonotoneX)
              .x(function(d) {
                return x2(d.Date);
              })
              .y0(height2)
              .y1(function(d) {
                return y2(d.Close);
              });

            context.append("path")
              .datum(data)
              .attr("class", "area")
              .attr("d", area2);


            freg.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height3 + ")")
              .call(xAxis3)
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", "-.55em")
              .attr("transform", "rotate(-90)");

            freg.append("g")
              .attr("class", "axis axis--y")
              .call(yAxis3);

            // Add a rect for each date.
            var rect = freg.selectAll("rect")
              .data(data)
              .enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) {
                return x3(d.Date);
              })
              .attr("y", function(d) {
                return y3(d.High);
              })
              .attr("height", function(d) {
                y3(d.High);
                y3(d.Low);

                return y3(d.Low) - y3(d.High);
              })
              .attr("width", x3.bandwidth());



            //create brush function redraw scatterplot with selection
            function brushed() {

              if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom") return; // ignore brush-by-zoom


              var selection = d3.event.selection;
              x.domain(selection.map(x2.invert, x2));
              focus.select(".area").attr("d", area);
              focus.selectAll(".dot")
                .attr("cx", function(d) {
                  return x(d.Date);
                })
                .attr("cy", function(d) {
                  return y(d.Close);
                });
              focus.select(".axis--x").call(xAxis);

              x3.domain();


              var range = selection.map(x2.invert, x2);

              x3.domain(data.map(function(d) {
                if (range[0] <= d.Date && d.Date <= range[1])
                  return d.Date;
              }));


              freg.selectAll("rect")
                .attr("x", function(d) {

                  if (range[0] <= d.Date && d.Date <= range[1])
                    return x3(d.Date);
                })
                .attr("y", function(d) {
                  if (range[0] <= d.Date && d.Date <= range[1])
                    return y3(d.High);
                })
                .attr('date', function(d) {
                  if (range[0] <= d.Date && d.Date <= range[1])
                  return d.Date;
                })
                .attr("height", function(d) {

                  y3(d.High);
                  y3(d.Low);

                  if (range[0] <= d.Date && d.Date <= range[1])
                  return y3(d.Low) - y3(d.High);
                })
                .attr("width", x3.bandwidth());





              freg.select(".axis--x").call(xAxis3)
                .selectAll("text")
                .text(function(d) {

                  if(!!d){
                   var formatTime = d3.timeFormat("%m-%d");
                   return formatTime(d);
                  }})
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", "-.55em")
                .attr("transform", "rotate(-90)");

            }







          }
        });

      });
    }
  };
}]);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImRpcmVjdGl2ZXMvY2hhcnQvY2hhcnQuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJtYWluLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuYW5ndWxhci5tb2R1bGUoJ2QzJywgW10pXG4gIC5mYWN0b3J5KCdkM1NlcnZpY2UnLCBbJyRkb2N1bWVudCcsICckcScsICckcm9vdFNjb3BlJyxcbiAgICBmdW5jdGlvbigkZG9jdW1lbnQsICRxLCAkcm9vdFNjb3BlKSB7XG4gICAgICB2YXIgZCA9ICRxLmRlZmVyKCk7XG4gICAgICBmdW5jdGlvbiBvblNjcmlwdExvYWQoKSB7XG4gICAgICAgIC8vIExvYWQgY2xpZW50IGluIHRoZSBicm93c2VyXG4gICAgICAgICRyb290U2NvcGUuJGFwcGx5KGZ1bmN0aW9uKCkgeyBkLnJlc29sdmUod2luZG93LmQzKTsgfSk7XG4gICAgICB9O1xuXG4gICAgICB2YXIgc2NyaXB0VGFnID0gJGRvY3VtZW50WzBdLmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgICAgc2NyaXB0VGFnLnR5cGUgPSAndGV4dC9qYXZhc2NyaXB0JztcbiAgICAgIHNjcmlwdFRhZy5hc3luYyA9IHRydWU7XG4gICAgICBzY3JpcHRUYWcuc3JjID0gJ2h0dHA6Ly9kM2pzLm9yZy9kMy52NC5taW4uanMnO1xuICAgICAgc2NyaXB0VGFnLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSA9PSAnY29tcGxldGUnKSBvblNjcmlwdExvYWQoKTtcbiAgICAgIH07XG4gICAgICBzY3JpcHRUYWcub25sb2FkID0gb25TY3JpcHRMb2FkO1xuXG4gICAgICB2YXIgcyA9ICRkb2N1bWVudFswXS5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYm9keScpWzBdO1xuICAgICAgcy5hcHBlbmRDaGlsZChzY3JpcHRUYWcpO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgZDM6IGZ1bmN0aW9uKCkgeyByZXR1cm4gZC5wcm9taXNlOyB9XG4gICAgICB9O1xufV0pO1xuXG5cbnZhciBtb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgnYXBwJywgWydkMyddKTtcbm1vZHVsZS5jb25maWcoZnVuY3Rpb24oJGxvY2F0aW9uUHJvdmlkZXIpIHtcbiAgJGxvY2F0aW9uUHJvdmlkZXIuaHRtbDVNb2RlKHRydWUpO1xufSk7XG5tb2R1bGUuc2VydmljZSgnU3RvY2tTZXJ2aWNlJywgU3RvY2tTZXJ2aWNlKTtcbm1vZHVsZS5jb250cm9sbGVyKCdteUNvbnRyb2xsZXInLCBteUNvbnRyb2xsZXIpO1xuXG5mdW5jdGlvbiBteUNvbnRyb2xsZXIoU3RvY2tTZXJ2aWNlLCAkc2NvcGUpIHtcbiAgdmFyIG1vZGVsID0gdGhpcztcbiAgdmFyIGNvbXBhbnlOYW1lcyA9IFtdO1xuICB2YXIgY29tcGFueSA9IHt9O1xuICBtb2RlbC5jb21wYW5pZXNOYW1lcyA9IFsnQ1NDTycsICdNU0ZUJywgJ0FEQkUnXTtcblxuICBtb2RlbC5zaG93Q29tcGFueSA9IGZ1bmN0aW9uKG5hbWUpe1xuICAgIGlmKCEhY29tcGFueVtuYW1lXSl7XG4gICAgICBtb2RlbC5jb21wYW55ID0gY29tcGFueVtuYW1lXTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29tcGFueVtuYW1lXSA9IFtdO1xuICAgIFN0b2NrU2VydmljZS5nZXRDb21wYW55RGF0ZShuYW1lKS50aGVuKGZ1bmN0aW9uKHJlc3BvbnNlKXtcbiAgICAgIHZhciBkYXRhPXJlc3BvbnNlLnF1b3RlO1xuICAgICAgYW5ndWxhci5mb3JFYWNoKGRhdGEsIGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgICAgIHZhbHVlLkRhdGUgPSBuZXcgRGF0ZSh2YWx1ZS5EYXRlLnNwbGl0KCctJykuam9pbignLCcpKTtcbiAgICAgICAgY29tcGFueVtuYW1lXS5wdXNoKHZhbHVlKTtcbiAgICAgICAgbW9kZWwuY29tcGFueU5hbWVzID0gY29tcGFueU5hbWVzO1xuICAgICAgICBtb2RlbC5jb21wYW55ID0gY29tcGFueVtuYW1lXTtcblxuICAgICAgfSk7XG4gICAgfSwgZnVuY3Rpb24oZXJyb3Ipe1xuICAgICAgYWxlcnQoZXJyb3IpO1xuICAgIH0pO1xuICB9O1xufTtcblxuXG5mdW5jdGlvbiBTdG9ja1NlcnZpY2UoJGh0dHAsICRxKSB7XG4gIHZhciBkb21haW4gPSBcImh0dHA6Ly9xdWVyeS55YWhvb2FwaXMuY29tL3YxL3B1YmxpYy95cWw/cT1cIjtcbiAgdmFyIHF1ZXJ5ID0gXCImZm9ybWF0PWpzb24mZGlhZ25vc3RpY3M9dHJ1ZSZlbnY9aHR0cDovL2RhdGF0YWJsZXMub3JnL2FsbHRhYmxlcy5lbnZcIjtcblxuICByZXR1cm4ge1xuICAgIGdldENvbXBhbnlEYXRlOiBmdW5jdGlvbihuYW1lKXtcbiAgICAgIHZhciB1cmwgPSBkb21haW4gK1xuICAgICAgZW5jb2RlVVJJKFwic2VsZWN0ICogZnJvbSB5YWhvby5maW5hbmNlLmhpc3RvcmljYWxkYXRhIHdoZXJlIHN5bWJvbCBpbignXCJcbiAgICAgICArIG5hbWUgK1xuICAgICAgIFwiJylhbmQgc3RhcnREYXRlID0gJzIwMTYtMDEtMDEnIGFuZCBlbmREYXRlID0gJzIwMTYtMDYtMzAnXCIpICtcbiAgICAgIHF1ZXJ5O1xuXG4gICAgICB2YXIgZGVmZXJyZWQgPSAkcS5kZWZlcigpO1xuICAgICAgJGh0dHAuZ2V0KHVybCkudGhlbihmdW5jdGlvbihyZXNwb25zZSkge1xuICAgICAgICB2YXIgZGF0ZSA9IGFuZ3VsYXIuZnJvbUpzb24ocmVzcG9uc2UuZGF0YS5xdWVyeS5yZXN1bHRzKTtcbiAgICAgICAgZGVmZXJyZWQucmVzb2x2ZShkYXRlKTtcbiAgICAgIH0sIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgIGRlZmVycmVkLnJlamVjdCh7IG1lc3NhZ2U6ICdQcm9ibGVtIHdpdGggY29ubmVjdGlvbicgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBkZWZlcnJlZC5wcm9taXNlO1xuICAgIH1cbiAgfTtcbn1cbiIsIid1c2Ugc3RyaWN0JztcblxuYW5ndWxhci5tb2R1bGUoJ2FwcCcpLmRpcmVjdGl2ZSgnY2hhcnQnLCBbJ2QzU2VydmljZScsIGZ1bmN0aW9uKGQzU2VydmljZSkge1xuICByZXR1cm4ge1xuICAgIHJlc3RyaWN0OiAnRScsXG4gICAgc2NvcGU6IHtcbiAgICAgIGl0ZW06ICc9bmdNb2RlbCdcbiAgICB9LFxuICAgIGxpbms6IGZ1bmN0aW9uKHNjb3BlLCBlbGVtZW50LCBpQXR0cnMpIHtcblxuICAgICAgdmFyIGl0ZW07XG5cbiAgICAgIGZ1bmN0aW9uIGdldERhdGUoZGF0ZSkge1xuICAgICAgICByZXR1cm4gbmV3IERhdGUoZGF0ZSk7XG4gICAgICB9XG4gICAgICBkM1NlcnZpY2UuZDMoKS50aGVuKGZ1bmN0aW9uKGQzKSB7XG5cblxuICAgICAgICBzY29wZS4kd2F0Y2goJ2l0ZW0nLCBmdW5jdGlvbihuVmFsKSB7XG4gICAgICAgICAgaWYgKCEhblZhbCkge1xuICAgICAgICAgICAgdmFyIHN2ZztcbiAgICAgICAgICAgIGQzLnNlbGVjdChcIiNJRFwiKS5yZW1vdmUoKTtcblxuXG5cbiAgICAgICAgICAgIHZhciBkYXRhID0gYW5ndWxhci5jb3B5KG5WYWwpLnJldmVyc2UoKTtcblxuICAgICAgICAgICAgdmFyIG1hcmdpbiA9IHsgdG9wOiAyMCwgcmlnaHQ6IDIwLCBib3R0b206IDQxMCwgbGVmdDogNTAgfSxcbiAgICAgICAgICAgICAgbWFyZ2luMiA9IHsgdG9wOiA0MzAsIHJpZ2h0OiAyMCwgYm90dG9tOiAzMzAsIGxlZnQ6IDUwIH0sXG4gICAgICAgICAgICAgIG1hcmdpbjMgPSB7IHRvcDogNTAwLCByaWdodDogMjAsIGJvdHRvbTogNDAsIGxlZnQ6IDUwIH0sXG4gICAgICAgICAgICAgIHdpZHRoID0gMTIwMCAtIG1hcmdpbi5sZWZ0IC0gbWFyZ2luLnJpZ2h0LFxuICAgICAgICAgICAgICBoZWlnaHQgPSA4MDAgLSBtYXJnaW4udG9wIC0gbWFyZ2luLmJvdHRvbSxcbiAgICAgICAgICAgICAgaGVpZ2h0MiA9IDgwMCAtIG1hcmdpbjIudG9wIC0gbWFyZ2luMi5ib3R0b20sXG4gICAgICAgICAgICAgIGhlaWdodDMgPSA4MDAgLSBtYXJnaW4zLnRvcCAtIG1hcmdpbjMuYm90dG9tO1xuXG5cbiAgICAgICAgICAgIHZhciB4ID0gZDMuc2NhbGVUaW1lKCkucmFuZ2UoWzAsIHdpZHRoXSksXG4gICAgICAgICAgICAgIHgyID0gZDMuc2NhbGVUaW1lKCkucmFuZ2UoWzAsIHdpZHRoXSksXG4gICAgICAgICAgICAgIC8veDMgPSBkMy5zY2FsZVRpbWUoKS5yYW5nZVJvdW5kKFswLCB3aWR0aF0pLFxuICAgICAgICAgICAgICB4MyA9IGQzLnNjYWxlQmFuZCgpLnJhbmdlUm91bmQoWzAsIHdpZHRoXSkucGFkZGluZygwLjEpLmFsaWduKDAuMSksXG4gICAgICAgICAgICAgIHkgPSBkMy5zY2FsZUxpbmVhcigpLnJhbmdlKFtoZWlnaHQsIDBdKSxcbiAgICAgICAgICAgICAgeTIgPSBkMy5zY2FsZUxpbmVhcigpLnJhbmdlKFtoZWlnaHQyLCAwXSksXG4gICAgICAgICAgICAgIHkzID0gZDMuc2NhbGVMaW5lYXIoKS5yYW5nZShbaGVpZ2h0MywgMF0pO1xuXG4gICAgICAgICAgICB2YXIgeEF4aXMgPSBkMy5heGlzQm90dG9tKHgpLFxuICAgICAgICAgICAgICB4QXhpczIgPSBkMy5heGlzQm90dG9tKHgyKSxcbiAgICAgICAgICAgICAgeEF4aXMzID0gZDMuYXhpc0JvdHRvbSh4MykudGlja0Zvcm1hdChkMy50aW1lRm9ybWF0KFwiJW0tJWRcIikpLFxuICAgICAgICAgICAgICB5QXhpcyA9IGQzLmF4aXNMZWZ0KHkpLFxuICAgICAgICAgICAgICB5QXhpczMgPSBkMy5heGlzTGVmdCh5Myk7XG5cbiAgICAgICAgICAgIHZhciBicnVzaCA9IGQzLmJydXNoWCgpXG4gICAgICAgICAgICAgIC5leHRlbnQoW1xuICAgICAgICAgICAgICAgIFswLCAwXSxcbiAgICAgICAgICAgICAgICBbd2lkdGgsIGhlaWdodDJdXG4gICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICAgIC5vbihcImJydXNoXCIsIGJydXNoZWQpO1xuXG4gICAgICAgICAgICBzdmcgPSBkMy5zZWxlY3QoZWxlbWVudFswXSkuYXBwZW5kKFwic3ZnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiaWRcIiwgXCJJRFwiKVxuICAgICAgICAgICAgICAuYXR0cihcIndpZHRoXCIsIHdpZHRoICsgbWFyZ2luLmxlZnQgKyBtYXJnaW4ucmlnaHQpXG4gICAgICAgICAgICAgIC5hdHRyKFwiaGVpZ2h0XCIsIGhlaWdodCArIG1hcmdpbi50b3AgKyBtYXJnaW4uYm90dG9tKTtcblxuICAgICAgICAgICAgc3ZnLmFwcGVuZChcImRlZnNcIikuYXBwZW5kKFwiY2xpcFBhdGhcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJpZFwiLCBcImNsaXBcIilcbiAgICAgICAgICAgICAgLmFwcGVuZChcInJlY3RcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aClcbiAgICAgICAgICAgICAgLmF0dHIoXCJoZWlnaHRcIiwgaGVpZ2h0KTtcblxuICAgICAgICAgICAgdmFyIGZvY3VzID0gc3ZnLmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImZvY3VzXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgbWFyZ2luLmxlZnQgKyBcIixcIiArIG1hcmdpbi50b3AgKyBcIilcIik7XG5cbiAgICAgICAgICAgIHZhciBjb250ZXh0ID0gc3ZnLmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImNvbnRleHRcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoXCIgKyBtYXJnaW4yLmxlZnQgKyBcIixcIiArIG1hcmdpbjIudG9wICsgXCIpXCIpO1xuXG4gICAgICAgICAgICB2YXIgZnJlZyA9IHN2Zy5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJmcmVnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgbWFyZ2luMy5sZWZ0ICsgXCIsXCIgKyBtYXJnaW4zLnRvcCArIFwiKVwiKTtcblxuXG5cblxuICAgICAgICAgICAgeC5kb21haW4oZDMuZXh0ZW50KGRhdGEsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGQuRGF0ZTtcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgICAgIHkuZG9tYWluKFtkMy5taW4oZGF0YSwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICByZXR1cm4gZC5Mb3c7XG4gICAgICAgICAgICB9KSwgZDMubWF4KGRhdGEsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGQuSGlnaDtcbiAgICAgICAgICAgIH0pXSk7XG4gICAgICAgICAgICB4Mi5kb21haW4oeC5kb21haW4oKSk7XG4gICAgICAgICAgICB5Mi5kb21haW4oeS5kb21haW4oKSk7XG4gICAgICAgICAgICAvL3gzLmRvbWFpbih4LmRvbWFpbigpKTtcbiAgICAgICAgICAgIHgzLmRvbWFpbihkYXRhLm1hcChmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBkLkRhdGU7XG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIHkzLmRvbWFpbih5LmRvbWFpbigpKTtcblxuXG4gICAgICAgICAgICB2YXIgYXJlYSA9IGQzLmFyZWEoKVxuICAgICAgICAgICAgICAuY3VydmUoZDMuY3VydmVNb25vdG9uZVgpXG4gICAgICAgICAgICAgIC54KGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geChkLkRhdGUpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAueTAoaGVpZ2h0KVxuICAgICAgICAgICAgICAueTEoZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB5KGQuQ2xvc2UpO1xuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZm9jdXMuYXBwZW5kKFwicGF0aFwiKVxuICAgICAgICAgICAgICAuZGF0YShbZGF0YV0pXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJhcmVhXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiZFwiLCBhcmVhKTtcblxuXG4gICAgICAgICAgICAvLyBhcHBlbmQgc2NhdHRlciBwbG90IHRvIG1haW4gY2hhcnQgYXJlYVxuICAgICAgICAgICAgdmFyIGRvdHMgPSBmb2N1cy5hcHBlbmQoXCJnXCIpO1xuICAgICAgICAgICAgZG90cy5hdHRyKFwiY2xpcC1wYXRoXCIsIFwidXJsKCNjbGlwKVwiKTtcbiAgICAgICAgICAgIGRvdHMuc2VsZWN0QWxsKFwiZG90XCIpXG4gICAgICAgICAgICAgIC5kYXRhKGRhdGEpXG4gICAgICAgICAgICAgIC5lbnRlcigpLmFwcGVuZChcImNpcmNsZVwiKVxuICAgICAgICAgICAgICAuYXR0cignY2xhc3MnLCAnZG90JylcbiAgICAgICAgICAgICAgLmF0dHIoXCJyXCIsIDMpXG4gICAgICAgICAgICAgIC5zdHlsZShcIm9wYWNpdHlcIiwgLjUpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY3hcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4KGQuRGF0ZSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC5hdHRyKFwiY3lcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB5KGQuQ2xvc2UpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAub24oJ21vdXNlb3ZlcicsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICBkMy5zZWxlY3QodGhpcykuYXR0cigncicsIDcpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGZvcm1hdFRpbWUgPSBkMy50aW1lRm9ybWF0KFwiJWUgJUJcIilcblxuXG4gICAgICAgICAgICAgICAgZGl2Lmh0bWwoXG4gICAgICAgICAgICAgICAgICAgICc8dGFibGU+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdEYXRlJyArICc8L3RkPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyBmb3JtYXRUaW1lKGQuRGF0ZSkgKyAnPC90ZD4nICsgJzwvdHI+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdPcGVuJyArICc8L3RkPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyBkLk9wZW4gKyAnPC90ZD4nICsgJzwvdHI+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdDbG9zZScgKyAnPC90ZD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgZC5DbG9zZSArICc8L3RkPicgKyAnPC90cj4nICsgJzx0cj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgJ0hpZ2gnICsgJzwvdGQ+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArIGQuSGlnaCArICc8L3RkPicgKyAnPC90cj4nICsgJzx0cj4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgJ0xvdycgKyAnPC90ZD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgZC5Mb3cgKyAnPC90ZD4nICsgJzwvdHI+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdWb2x1bWUnICsgJzwvdGQ+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArIGQuVm9sdW1lICsgJzwvdGQ+JyArICc8L3RyPicgKyAnPC90YWJsZT4nXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAuc3R5bGUoXCJsZWZ0XCIsIChkMy5ldmVudC5wYWdlWCkgKyBcInB4XCIpXG4gICAgICAgICAgICAgICAgICAuc3R5bGUoXCJ0b3BcIiwgKGQzLmV2ZW50LnBhZ2VZIC0gcGFyc2VJbnQoZGl2LnN0eWxlKCdoZWlnaHQnKSwgMTApKSArIFwicHhcIilcbiAgICAgICAgICAgICAgICAgIC50cmFuc2l0aW9uKClcbiAgICAgICAgICAgICAgICAgIC5kdXJhdGlvbigyMDApXG4gICAgICAgICAgICAgICAgICAuc3R5bGUoXCJvcGFjaXR5XCIsIC45KVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAub24oJ21vdXNlb3V0JywgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIGQzLnNlbGVjdCh0aGlzKS5hdHRyKCdyJywgMyk7XG4gICAgICAgICAgICAgICAgZGl2LnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgICAgICAgLmR1cmF0aW9uKDUwMClcbiAgICAgICAgICAgICAgICAgIC5zdHlsZShcIm9wYWNpdHlcIiwgMCk7XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBmb2N1cy5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJheGlzIGF4aXMtLXhcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJmaWxsXCIsIFwibm9uZVwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgwLFwiICsgaGVpZ2h0ICsgXCIpXCIpXG4gICAgICAgICAgICAgIC5jYWxsKHhBeGlzKTtcblxuICAgICAgICAgICAgZm9jdXMuYXBwZW5kKFwiZ1wiKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwiYXhpcyBheGlzLS15XCIpXG4gICAgICAgICAgICAgIC5jYWxsKHlBeGlzKTtcblxuICAgICAgICAgICAgZm9jdXMuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInJvdGF0ZSgtOTApXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwieVwiLCAwIC0gbWFyZ2luLmxlZnQpXG4gICAgICAgICAgICAgIC5hdHRyKFwieFwiLCAwIC0gKGhlaWdodCAvIDIpKVxuICAgICAgICAgICAgICAuYXR0cihcImR5XCIsIFwiMWVtXCIpXG4gICAgICAgICAgICAgIC5zdHlsZShcInRleHQtYW5jaG9yXCIsIFwibWlkZGxlXCIpXG4gICAgICAgICAgICAgIC50ZXh0KFwiUHJpY2VcIik7XG5cbiAgICAgICAgICAgIHN2Zy5hcHBlbmQoXCJ0ZXh0XCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsXG4gICAgICAgICAgICAgICAgXCJ0cmFuc2xhdGUoXCIgKyAoKHdpZHRoICsgbWFyZ2luLnJpZ2h0ICsgbWFyZ2luLmxlZnQpIC8gMikgKyBcIiAsXCIgK1xuICAgICAgICAgICAgICAgIG1hcmdpbjMudG9wICsgXCIpXCIpXG4gICAgICAgICAgICAgIC5zdHlsZShcInRleHQtYW5jaG9yXCIsIFwibWlkZGxlXCIpXG4gICAgICAgICAgICAgIC50ZXh0KFwiRGF0ZVwiKTtcblxuICAgICAgICAgICAgLy8gRGVmaW5lIHRoZSBkaXYgZm9yIHRoZSB0b29sdGlwXG4gICAgICAgICAgICB2YXIgZGl2ID0gZDMuc2VsZWN0KGVsZW1lbnRbMF0pLmFwcGVuZChcImRpdlwiKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwidG9vbHRpcFwiKVxuICAgICAgICAgICAgICAuc3R5bGUoXCJvcGFjaXR5XCIsIDApO1xuXG5cblxuICAgICAgICAgICAgLy8gYXBwZW5kIHNjYXR0ZXIgcGxvdCB0byBicnVzaCBjaGFydCBhcmVhXG4gICAgICAgICAgICBjb250ZXh0LmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImF4aXMgYXhpcy0teFwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgwLFwiICsgaGVpZ2h0MiArIFwiKVwiKVxuICAgICAgICAgICAgICAuY2FsbCh4QXhpczIpO1xuXG4gICAgICAgICAgICBjb250ZXh0LmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImJydXNoXCIpXG4gICAgICAgICAgICAgIC5jYWxsKGJydXNoKVxuICAgICAgICAgICAgICAuY2FsbChicnVzaC5tb3ZlLCB4LnJhbmdlKCkpO1xuXG4gICAgICAgICAgICB2YXIgYXJlYTIgPSBkMy5hcmVhKClcbiAgICAgICAgICAgICAgLmN1cnZlKGQzLmN1cnZlTW9ub3RvbmVYKVxuICAgICAgICAgICAgICAueChmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHgyKGQuRGF0ZSk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC55MChoZWlnaHQyKVxuICAgICAgICAgICAgICAueTEoZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB5MihkLkNsb3NlKTtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGNvbnRleHQuYXBwZW5kKFwicGF0aFwiKVxuICAgICAgICAgICAgICAuZGF0dW0oZGF0YSlcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImFyZWFcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJkXCIsIGFyZWEyKTtcblxuXG4gICAgICAgICAgICBmcmVnLmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImF4aXMgYXhpcy0teFwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZSgwLFwiICsgaGVpZ2h0MyArIFwiKVwiKVxuICAgICAgICAgICAgICAuY2FsbCh4QXhpczMpXG4gICAgICAgICAgICAgIC5zZWxlY3RBbGwoXCJ0ZXh0XCIpXG4gICAgICAgICAgICAgIC5zdHlsZShcInRleHQtYW5jaG9yXCIsIFwiZW5kXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiZHhcIiwgXCItLjhlbVwiKVxuICAgICAgICAgICAgICAuYXR0cihcImR5XCIsIFwiLS41NWVtXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwicm90YXRlKC05MClcIik7XG5cbiAgICAgICAgICAgIGZyZWcuYXBwZW5kKFwiZ1wiKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwiYXhpcyBheGlzLS15XCIpXG4gICAgICAgICAgICAgIC5jYWxsKHlBeGlzMyk7XG5cbiAgICAgICAgICAgIC8vIEFkZCBhIHJlY3QgZm9yIGVhY2ggZGF0ZS5cbiAgICAgICAgICAgIHZhciByZWN0ID0gZnJlZy5zZWxlY3RBbGwoXCJyZWN0XCIpXG4gICAgICAgICAgICAgIC5kYXRhKGRhdGEpXG4gICAgICAgICAgICAgIC5lbnRlcigpLmFwcGVuZChcInJlY3RcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImJhclwiKVxuICAgICAgICAgICAgICAuYXR0cihcInhcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4MyhkLkRhdGUpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuYXR0cihcInlcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB5MyhkLkhpZ2gpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuYXR0cihcImhlaWdodFwiLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgeTMoZC5IaWdoKTtcbiAgICAgICAgICAgICAgICB5MyhkLkxvdyk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4geTMoZC5Mb3cpIC0geTMoZC5IaWdoKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmF0dHIoXCJ3aWR0aFwiLCB4My5iYW5kd2lkdGgoKSk7XG5cblxuXG4gICAgICAgICAgICAvL2NyZWF0ZSBicnVzaCBmdW5jdGlvbiByZWRyYXcgc2NhdHRlcnBsb3Qgd2l0aCBzZWxlY3Rpb25cbiAgICAgICAgICAgIGZ1bmN0aW9uIGJydXNoZWQoKSB7XG5cbiAgICAgICAgICAgICAgaWYgKGQzLmV2ZW50LnNvdXJjZUV2ZW50ICYmIGQzLmV2ZW50LnNvdXJjZUV2ZW50LnR5cGUgPT09IFwiem9vbVwiKSByZXR1cm47IC8vIGlnbm9yZSBicnVzaC1ieS16b29tXG5cblxuICAgICAgICAgICAgICB2YXIgc2VsZWN0aW9uID0gZDMuZXZlbnQuc2VsZWN0aW9uO1xuICAgICAgICAgICAgICB4LmRvbWFpbihzZWxlY3Rpb24ubWFwKHgyLmludmVydCwgeDIpKTtcbiAgICAgICAgICAgICAgZm9jdXMuc2VsZWN0KFwiLmFyZWFcIikuYXR0cihcImRcIiwgYXJlYSk7XG4gICAgICAgICAgICAgIGZvY3VzLnNlbGVjdEFsbChcIi5kb3RcIilcbiAgICAgICAgICAgICAgICAuYXR0cihcImN4XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB4KGQuRGF0ZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuYXR0cihcImN5XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB5KGQuQ2xvc2UpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICBmb2N1cy5zZWxlY3QoXCIuYXhpcy0teFwiKS5jYWxsKHhBeGlzKTtcblxuICAgICAgICAgICAgICB4My5kb21haW4oKTtcblxuXG4gICAgICAgICAgICAgIHZhciByYW5nZSA9IHNlbGVjdGlvbi5tYXAoeDIuaW52ZXJ0LCB4Mik7XG5cbiAgICAgICAgICAgICAgeDMuZG9tYWluKGRhdGEubWFwKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICBpZiAocmFuZ2VbMF0gPD0gZC5EYXRlICYmIGQuRGF0ZSA8PSByYW5nZVsxXSlcbiAgICAgICAgICAgICAgICAgIHJldHVybiBkLkRhdGU7XG4gICAgICAgICAgICAgIH0pKTtcblxuXG4gICAgICAgICAgICAgIGZyZWcuc2VsZWN0QWxsKFwicmVjdFwiKVxuICAgICAgICAgICAgICAgIC5hdHRyKFwieFwiLCBmdW5jdGlvbihkKSB7XG5cbiAgICAgICAgICAgICAgICAgIGlmIChyYW5nZVswXSA8PSBkLkRhdGUgJiYgZC5EYXRlIDw9IHJhbmdlWzFdKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4geDMoZC5EYXRlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5hdHRyKFwieVwiLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgICBpZiAocmFuZ2VbMF0gPD0gZC5EYXRlICYmIGQuRGF0ZSA8PSByYW5nZVsxXSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHkzKGQuSGlnaCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuYXR0cignZGF0ZScsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICAgIGlmIChyYW5nZVswXSA8PSBkLkRhdGUgJiYgZC5EYXRlIDw9IHJhbmdlWzFdKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIGQuRGF0ZTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5hdHRyKFwiaGVpZ2h0XCIsIGZ1bmN0aW9uKGQpIHtcblxuICAgICAgICAgICAgICAgICAgeTMoZC5IaWdoKTtcbiAgICAgICAgICAgICAgICAgIHkzKGQuTG93KTtcblxuICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlWzBdIDw9IGQuRGF0ZSAmJiBkLkRhdGUgPD0gcmFuZ2VbMV0pXG4gICAgICAgICAgICAgICAgICByZXR1cm4geTMoZC5Mb3cpIC0geTMoZC5IaWdoKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIC5hdHRyKFwid2lkdGhcIiwgeDMuYmFuZHdpZHRoKCkpO1xuXG5cblxuXG5cbiAgICAgICAgICAgICAgZnJlZy5zZWxlY3QoXCIuYXhpcy0teFwiKS5jYWxsKHhBeGlzMylcbiAgICAgICAgICAgICAgICAuc2VsZWN0QWxsKFwidGV4dFwiKVxuICAgICAgICAgICAgICAgIC50ZXh0KGZ1bmN0aW9uKGQpIHtcblxuICAgICAgICAgICAgICAgICAgaWYoISFkKXtcbiAgICAgICAgICAgICAgICAgICB2YXIgZm9ybWF0VGltZSA9IGQzLnRpbWVGb3JtYXQoXCIlbS0lZFwiKTtcbiAgICAgICAgICAgICAgICAgICByZXR1cm4gZm9ybWF0VGltZShkKTtcbiAgICAgICAgICAgICAgICAgIH19KVxuICAgICAgICAgICAgICAgIC5zdHlsZShcInRleHQtYW5jaG9yXCIsIFwiZW5kXCIpXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJkeFwiLCBcIi0uOGVtXCIpXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJkeVwiLCBcIi0uNTVlbVwiKVxuICAgICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwicm90YXRlKC05MClcIik7XG5cbiAgICAgICAgICAgIH1cblxuXG5cblxuXG5cblxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1dKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
