'use strict';

angular.module('d3', [])
  .factory('d3Service', ['$document', '$q', '$rootScope',
    function($document, $q, $rootScope) {
      var d = $q.defer();
      function onScriptLoad() {
        // Load client in the browser
        $rootScope.$apply(function() { d.resolve(window.d3); });
      };

      var scriptTag = $document[0].createElement('script');
      scriptTag.type = 'text/javascript';
      scriptTag.async = true;
      scriptTag.src = 'http://d3js.org/d3.v4.min.js';
      scriptTag.onreadystatechange = function () {
        if (this.readyState == 'complete') onScriptLoad();
      };
      scriptTag.onload = onScriptLoad;

      var s = $document[0].getElementsByTagName('body')[0];
      s.appendChild(scriptTag);
      return {
        d3: function() { return d.promise; }
      };
}]);


var module = angular.module('app', ['d3']);
module.config(function($locationProvider) {
  $locationProvider.html5Mode(true);
});
module.service('StockService', StockService);
module.controller('myController', myController);

function myController(StockService) {
  var model = this;
  var companyNames = [];
  var company = {};
  model.companiesNames = ['CSCO', 'MSFT', 'ADBE'];

  model.showCompany = function(name){
    if(!!company[name]){
      model.company = company[name];
      return;
    }
    company[name] = [];
    StockService.getCompanyDate(name).then(function(response){
      var data=response.quote;
      angular.forEach(data, function(value) {
        value.Date = new Date(value.Date.split('-').join(','));
        company[name].push(value);
        model.companyNames = companyNames;
        model.company = company[name];

      });
    }, function(error){
      alert(error.message);
    });
  };
};


function StockService($http, $q) {
  var domain = "http://query.yahooapis.com/v1/public/yql?q=";
  var query = "&format=json&diagnostics=true&env=http://datatables.org/alltables.env";

  return {
    getCompanyDate: function(name){
      var url = domain +
      encodeURI("select * from yahoo.finance.historicaldata where symbol in('"
       + name +
       "')and startDate = '2016-01-01' and endDate = '2016-06-30'") +
      query;

      var deferred = $q.defer();
      $http.get(url).then(function(response) {
        var date = angular.fromJson(response.data.query.results);
        deferred.resolve(date);
      }, function(error) {
        deferred.reject({ message: 'Problem with connection' });
      });
      return deferred.promise;
    }
  };
}

'use strict';

angular.module('app').directive('chart', ['d3Service', function(d3Service) {
  return {
    restrict: 'E',
    scope: {
      item: '<?ngModel'
    },
    link: link
  };


 function link(scope, element) {
      function getDate(date) {
        return new Date(date);
      }
      d3Service.d3().then(function(d3) {

        scope.$watch('item', function(nVal) {
          if (!!nVal) {
            var svg;
            d3.select("#ID").remove();

            var data = angular.copy(nVal).reverse();

            var margin = { top: 20, right: 20, bottom: 410, left: 50 },
              margin2 = { top: 430, right: 20, bottom: 330, left: 50 },
              margin3 = { top: 500, right: 20, bottom: 40, left: 50 },
              width = 1200 - margin.left - margin.right,
              height = 800 - margin.top - margin.bottom,
              height2 = 800 - margin2.top - margin2.bottom,
              height3 = 800 - margin3.top - margin3.bottom;

            var x = d3.scaleTime().range([0, width]),
              x2 = d3.scaleTime().range([0, width]),
              x3 = d3.scaleBand().rangeRound([0, width]).padding(0.1).align(0.1),
              y = d3.scaleLinear().range([height, 0]),
              y2 = d3.scaleLinear().range([height2, 0]),
              y3 = d3.scaleLinear().range([height3, 0]);

            var xAxis = d3.axisBottom(x),
              xAxis2 = d3.axisBottom(x2),
              xAxis3 = d3.axisBottom(x3).tickFormat(d3.timeFormat("%m-%d")),
              yAxis = d3.axisLeft(y),
              yAxis3 = d3.axisLeft(y3);

            var brush = d3.brushX()
              .extent([
                [0, 0],
                [width, height2]
              ])
              .on("brush", brushed);

            svg = d3.select(element[0]).append("svg")
              .attr("id", "ID")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom);

            svg.append("defs").append("clipPath")
              .attr("id", "clip")
              .append("rect")
              .attr("width", width)
              .attr("height", height);

            var focus = svg.append("g")
              .attr("class", "focus")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            var context = svg.append("g")
              .attr("class", "context")
              .attr("transform", "translate(" + margin2.left + "," + margin2.top + ")");

            var freg = svg.append("g")
              .attr("class", "freg")
              .attr("transform", "translate(" + margin3.left + "," + margin3.top + ")");




            x.domain(d3.extent(data, function(d) {
              return d.Date;
            }));
            y.domain([d3.min(data, function(d) {
              return d.Low;
            }), d3.max(data, function(d) {
              return d.High;
            })]);
            x2.domain(x.domain());
            y2.domain(y.domain());
            //x3.domain(x.domain());
            x3.domain(data.map(function(d) {
              return d.Date;
            }));

            y3.domain(y.domain());


            var area = d3.area()
              .curve(d3.curveMonotoneX)
              .x(function(d) {
                return x(d.Date);
              })
              .y0(height)
              .y1(function(d) {
                return y(d.Close);
              });

            focus.append("path")
              .data([data])
              .attr("class", "area")
              .attr("d", area);


            // append scatter plot to main chart area
            var dots = focus.append("g");
            dots.attr("clip-path", "url(#clip)");
            dots.selectAll("dot")
              .data(data)
              .enter().append("circle")
              .attr('class', 'dot')
              .attr("r", 3)
              .style("opacity", .5)
              .attr("cx", function(d) {
                return x(d.Date);
              })
              .attr("cy", function(d) {
                return y(d.Close);
              })
              .on('mouseover', function(d) {
                d3.select(this).attr('r', 7);

                var formatTime = d3.timeFormat("%e %B")


                div.html(
                    '<table>' + '<tr>' +
                    '<td>' + 'Date' + '</td>' +
                    '<td>' + formatTime(d.Date) + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Open' + '</td>' +
                    '<td>' + d.Open + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Close' + '</td>' +
                    '<td>' + d.Close + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'High' + '</td>' +
                    '<td>' + d.High + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Low' + '</td>' +
                    '<td>' + d.Low + '</td>' + '</tr>' + '<tr>' +
                    '<td>' + 'Volume' + '</td>' +
                    '<td>' + d.Volume + '</td>' + '</tr>' + '</table>'
                  )
                  .style("left", (d3.event.pageX) + "px")
                  .style("top", (d3.event.pageY - parseInt(div.style('height'), 10)) + "px")
                  .transition()
                  .duration(200)
                  .style("opacity", .9)
              })
              .on('mouseout', function(d) {
                d3.select(this).attr('r', 3);
                div.transition()
                  .duration(500)
                  .style("opacity", 0);
              });

            focus.append("g")
              .attr("class", "axis axis--x")
              .attr("fill", "none")
              .attr("transform", "translate(0," + height + ")")
              .call(xAxis);

            focus.append("g")
              .attr("class", "axis axis--y")
              .call(yAxis);

            focus.append("text")
              .attr("transform", "rotate(-90)")
              .attr("y", 0 - margin.left)
              .attr("x", 0 - (height / 2))
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .text("Price");

            svg.append("text")
              .attr("transform",
                "translate(" + ((width + margin.right + margin.left) / 2) + " ," +
                margin3.top + ")")
              .style("text-anchor", "middle")
              .text("Date");

            // Define the div for the tooltip
            var div = d3.select(element[0]).append("div")
              .attr("class", "tooltip")
              .style("opacity", 0);



            // append scatter plot to brush chart area
            context.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height2 + ")")
              .call(xAxis2);

            context.append("g")
              .attr("class", "brush")
              .call(brush)
              .call(brush.move, x.range());

            var area2 = d3.area()
              .curve(d3.curveMonotoneX)
              .x(function(d) {
                return x2(d.Date);
              })
              .y0(height2)
              .y1(function(d) {
                return y2(d.Close);
              });

            context.append("path")
              .datum(data)
              .attr("class", "area")
              .attr("d", area2);


            freg.append("g")
              .attr("class", "axis axis--x")
              .attr("transform", "translate(0," + height3 + ")")
              .call(xAxis3)
              .selectAll("text")
              .style("text-anchor", "end")
              .attr("dx", "-.8em")
              .attr("dy", "-.55em")
              .attr("transform", "rotate(-90)");

            freg.append("g")
              .attr("class", "axis axis--y")
              .call(yAxis3);

            // Add a rect for each date.
            var rect = freg.selectAll("rect")
              .data(data)
              .enter().append("rect")
              .attr("class", "bar")
              .attr("x", function(d) {
                return x3(d.Date);
              })
              .attr("y", function(d) {
                return y3(d.High);
              })
              .attr("height", function(d) {
                y3(d.High);
                y3(d.Low);

                return y3(d.Low) - y3(d.High);
              })
              .attr("width", x3.bandwidth());



            //create brush function redraw scatterplot with selection
            function brushed() {

              if (d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom") return; // ignore brush-by-zoom


              var selection = d3.event.selection;
              x.domain(selection.map(x2.invert, x2));
              focus.select(".area").attr("d", area);
              focus.selectAll(".dot")
                .attr("cx", function(d) {
                  return x(d.Date);
                })
                .attr("cy", function(d) {
                  return y(d.Close);
                });
              focus.select(".axis--x").call(xAxis);

              x3.domain();


              var range = selection.map(x2.invert, x2);

              x3.domain(data.map(function(d) {
                if (range[0] <= d.Date && d.Date <= range[1])
                  return d.Date;
              }));


              freg.selectAll("rect")
                .attr("x", function(d) {

                  if (range[0] <= d.Date && d.Date <= range[1])
                    return x3(d.Date);
                })
                .attr("y", function(d) {
                  if (range[0] <= d.Date && d.Date <= range[1])
                    return y3(d.High);
                })
                .attr('date', function(d) {
                  if (range[0] <= d.Date && d.Date <= range[1])
                  return d.Date;
                })
                .attr("height", function(d) {

                  y3(d.High);
                  y3(d.Low);

                  if (range[0] <= d.Date && d.Date <= range[1])
                  return y3(d.Low) - y3(d.High);
                })
                .attr("width", x3.bandwidth());

              freg.select(".axis--x").call(xAxis3)
                .selectAll("text")
                .text(function(d) {

                  if(!!d){
                   var formatTime = d3.timeFormat("%m-%d");
                   return formatTime(d);
                  }})
                .style("text-anchor", "end")
                .attr("dx", "-.8em")
                .attr("dy", "-.55em")
                .attr("transform", "rotate(-90)");

            }
          }
        });

      });
    }












}]);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImRpcmVjdGl2ZXMvY2hhcnQvY2hhcnQuZGlyZWN0aXZlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3RGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmFuZ3VsYXIubW9kdWxlKCdkMycsIFtdKVxuICAuZmFjdG9yeSgnZDNTZXJ2aWNlJywgWyckZG9jdW1lbnQnLCAnJHEnLCAnJHJvb3RTY29wZScsXG4gICAgZnVuY3Rpb24oJGRvY3VtZW50LCAkcSwgJHJvb3RTY29wZSkge1xuICAgICAgdmFyIGQgPSAkcS5kZWZlcigpO1xuICAgICAgZnVuY3Rpb24gb25TY3JpcHRMb2FkKCkge1xuICAgICAgICAvLyBMb2FkIGNsaWVudCBpbiB0aGUgYnJvd3NlclxuICAgICAgICAkcm9vdFNjb3BlLiRhcHBseShmdW5jdGlvbigpIHsgZC5yZXNvbHZlKHdpbmRvdy5kMyk7IH0pO1xuICAgICAgfTtcblxuICAgICAgdmFyIHNjcmlwdFRhZyA9ICRkb2N1bWVudFswXS5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgIHNjcmlwdFRhZy50eXBlID0gJ3RleHQvamF2YXNjcmlwdCc7XG4gICAgICBzY3JpcHRUYWcuYXN5bmMgPSB0cnVlO1xuICAgICAgc2NyaXB0VGFnLnNyYyA9ICdodHRwOi8vZDNqcy5vcmcvZDMudjQubWluLmpzJztcbiAgICAgIHNjcmlwdFRhZy5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgPT0gJ2NvbXBsZXRlJykgb25TY3JpcHRMb2FkKCk7XG4gICAgICB9O1xuICAgICAgc2NyaXB0VGFnLm9ubG9hZCA9IG9uU2NyaXB0TG9hZDtcblxuICAgICAgdmFyIHMgPSAkZG9jdW1lbnRbMF0uZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2JvZHknKVswXTtcbiAgICAgIHMuYXBwZW5kQ2hpbGQoc2NyaXB0VGFnKTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGQzOiBmdW5jdGlvbigpIHsgcmV0dXJuIGQucHJvbWlzZTsgfVxuICAgICAgfTtcbn1dKTtcblxuXG52YXIgbW9kdWxlID0gYW5ndWxhci5tb2R1bGUoJ2FwcCcsIFsnZDMnXSk7XG5tb2R1bGUuY29uZmlnKGZ1bmN0aW9uKCRsb2NhdGlvblByb3ZpZGVyKSB7XG4gICRsb2NhdGlvblByb3ZpZGVyLmh0bWw1TW9kZSh0cnVlKTtcbn0pO1xubW9kdWxlLnNlcnZpY2UoJ1N0b2NrU2VydmljZScsIFN0b2NrU2VydmljZSk7XG5tb2R1bGUuY29udHJvbGxlcignbXlDb250cm9sbGVyJywgbXlDb250cm9sbGVyKTtcblxuZnVuY3Rpb24gbXlDb250cm9sbGVyKFN0b2NrU2VydmljZSkge1xuICB2YXIgbW9kZWwgPSB0aGlzO1xuICB2YXIgY29tcGFueU5hbWVzID0gW107XG4gIHZhciBjb21wYW55ID0ge307XG4gIG1vZGVsLmNvbXBhbmllc05hbWVzID0gWydDU0NPJywgJ01TRlQnLCAnQURCRSddO1xuXG4gIG1vZGVsLnNob3dDb21wYW55ID0gZnVuY3Rpb24obmFtZSl7XG4gICAgaWYoISFjb21wYW55W25hbWVdKXtcbiAgICAgIG1vZGVsLmNvbXBhbnkgPSBjb21wYW55W25hbWVdO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb21wYW55W25hbWVdID0gW107XG4gICAgU3RvY2tTZXJ2aWNlLmdldENvbXBhbnlEYXRlKG5hbWUpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2Upe1xuICAgICAgdmFyIGRhdGE9cmVzcG9uc2UucXVvdGU7XG4gICAgICBhbmd1bGFyLmZvckVhY2goZGF0YSwgZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgICAgdmFsdWUuRGF0ZSA9IG5ldyBEYXRlKHZhbHVlLkRhdGUuc3BsaXQoJy0nKS5qb2luKCcsJykpO1xuICAgICAgICBjb21wYW55W25hbWVdLnB1c2godmFsdWUpO1xuICAgICAgICBtb2RlbC5jb21wYW55TmFtZXMgPSBjb21wYW55TmFtZXM7XG4gICAgICAgIG1vZGVsLmNvbXBhbnkgPSBjb21wYW55W25hbWVdO1xuXG4gICAgICB9KTtcbiAgICB9LCBmdW5jdGlvbihlcnJvcil7XG4gICAgICBhbGVydChlcnJvci5tZXNzYWdlKTtcbiAgICB9KTtcbiAgfTtcbn07XG5cblxuZnVuY3Rpb24gU3RvY2tTZXJ2aWNlKCRodHRwLCAkcSkge1xuICB2YXIgZG9tYWluID0gXCJodHRwOi8vcXVlcnkueWFob29hcGlzLmNvbS92MS9wdWJsaWMveXFsP3E9XCI7XG4gIHZhciBxdWVyeSA9IFwiJmZvcm1hdD1qc29uJmRpYWdub3N0aWNzPXRydWUmZW52PWh0dHA6Ly9kYXRhdGFibGVzLm9yZy9hbGx0YWJsZXMuZW52XCI7XG5cbiAgcmV0dXJuIHtcbiAgICBnZXRDb21wYW55RGF0ZTogZnVuY3Rpb24obmFtZSl7XG4gICAgICB2YXIgdXJsID0gZG9tYWluICtcbiAgICAgIGVuY29kZVVSSShcInNlbGVjdCAqIGZyb20geWFob28uZmluYW5jZS5oaXN0b3JpY2FsZGF0YSB3aGVyZSBzeW1ib2wgaW4oJ1wiXG4gICAgICAgKyBuYW1lICtcbiAgICAgICBcIicpYW5kIHN0YXJ0RGF0ZSA9ICcyMDE2LTAxLTAxJyBhbmQgZW5kRGF0ZSA9ICcyMDE2LTA2LTMwJ1wiKSArXG4gICAgICBxdWVyeTtcblxuICAgICAgdmFyIGRlZmVycmVkID0gJHEuZGVmZXIoKTtcbiAgICAgICRodHRwLmdldCh1cmwpLnRoZW4oZnVuY3Rpb24ocmVzcG9uc2UpIHtcbiAgICAgICAgdmFyIGRhdGUgPSBhbmd1bGFyLmZyb21Kc29uKHJlc3BvbnNlLmRhdGEucXVlcnkucmVzdWx0cyk7XG4gICAgICAgIGRlZmVycmVkLnJlc29sdmUoZGF0ZSk7XG4gICAgICB9LCBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICBkZWZlcnJlZC5yZWplY3QoeyBtZXNzYWdlOiAnUHJvYmxlbSB3aXRoIGNvbm5lY3Rpb24nIH0pO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gZGVmZXJyZWQucHJvbWlzZTtcbiAgICB9XG4gIH07XG59XG4iLCIndXNlIHN0cmljdCc7XG5cbmFuZ3VsYXIubW9kdWxlKCdhcHAnKS5kaXJlY3RpdmUoJ2NoYXJ0JywgWydkM1NlcnZpY2UnLCBmdW5jdGlvbihkM1NlcnZpY2UpIHtcbiAgcmV0dXJuIHtcbiAgICByZXN0cmljdDogJ0UnLFxuICAgIHNjb3BlOiB7XG4gICAgICBpdGVtOiAnPD9uZ01vZGVsJ1xuICAgIH0sXG4gICAgbGluazogbGlua1xuICB9O1xuXG5cbiBmdW5jdGlvbiBsaW5rKHNjb3BlLCBlbGVtZW50KSB7XG4gICAgICBmdW5jdGlvbiBnZXREYXRlKGRhdGUpIHtcbiAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGRhdGUpO1xuICAgICAgfVxuICAgICAgZDNTZXJ2aWNlLmQzKCkudGhlbihmdW5jdGlvbihkMykge1xuXG4gICAgICAgIHNjb3BlLiR3YXRjaCgnaXRlbScsIGZ1bmN0aW9uKG5WYWwpIHtcbiAgICAgICAgICBpZiAoISFuVmFsKSB7XG4gICAgICAgICAgICB2YXIgc3ZnO1xuICAgICAgICAgICAgZDMuc2VsZWN0KFwiI0lEXCIpLnJlbW92ZSgpO1xuXG4gICAgICAgICAgICB2YXIgZGF0YSA9IGFuZ3VsYXIuY29weShuVmFsKS5yZXZlcnNlKCk7XG5cbiAgICAgICAgICAgIHZhciBtYXJnaW4gPSB7IHRvcDogMjAsIHJpZ2h0OiAyMCwgYm90dG9tOiA0MTAsIGxlZnQ6IDUwIH0sXG4gICAgICAgICAgICAgIG1hcmdpbjIgPSB7IHRvcDogNDMwLCByaWdodDogMjAsIGJvdHRvbTogMzMwLCBsZWZ0OiA1MCB9LFxuICAgICAgICAgICAgICBtYXJnaW4zID0geyB0b3A6IDUwMCwgcmlnaHQ6IDIwLCBib3R0b206IDQwLCBsZWZ0OiA1MCB9LFxuICAgICAgICAgICAgICB3aWR0aCA9IDEyMDAgLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodCxcbiAgICAgICAgICAgICAgaGVpZ2h0ID0gODAwIC0gbWFyZ2luLnRvcCAtIG1hcmdpbi5ib3R0b20sXG4gICAgICAgICAgICAgIGhlaWdodDIgPSA4MDAgLSBtYXJnaW4yLnRvcCAtIG1hcmdpbjIuYm90dG9tLFxuICAgICAgICAgICAgICBoZWlnaHQzID0gODAwIC0gbWFyZ2luMy50b3AgLSBtYXJnaW4zLmJvdHRvbTtcblxuICAgICAgICAgICAgdmFyIHggPSBkMy5zY2FsZVRpbWUoKS5yYW5nZShbMCwgd2lkdGhdKSxcbiAgICAgICAgICAgICAgeDIgPSBkMy5zY2FsZVRpbWUoKS5yYW5nZShbMCwgd2lkdGhdKSxcbiAgICAgICAgICAgICAgeDMgPSBkMy5zY2FsZUJhbmQoKS5yYW5nZVJvdW5kKFswLCB3aWR0aF0pLnBhZGRpbmcoMC4xKS5hbGlnbigwLjEpLFxuICAgICAgICAgICAgICB5ID0gZDMuc2NhbGVMaW5lYXIoKS5yYW5nZShbaGVpZ2h0LCAwXSksXG4gICAgICAgICAgICAgIHkyID0gZDMuc2NhbGVMaW5lYXIoKS5yYW5nZShbaGVpZ2h0MiwgMF0pLFxuICAgICAgICAgICAgICB5MyA9IGQzLnNjYWxlTGluZWFyKCkucmFuZ2UoW2hlaWdodDMsIDBdKTtcblxuICAgICAgICAgICAgdmFyIHhBeGlzID0gZDMuYXhpc0JvdHRvbSh4KSxcbiAgICAgICAgICAgICAgeEF4aXMyID0gZDMuYXhpc0JvdHRvbSh4MiksXG4gICAgICAgICAgICAgIHhBeGlzMyA9IGQzLmF4aXNCb3R0b20oeDMpLnRpY2tGb3JtYXQoZDMudGltZUZvcm1hdChcIiVtLSVkXCIpKSxcbiAgICAgICAgICAgICAgeUF4aXMgPSBkMy5heGlzTGVmdCh5KSxcbiAgICAgICAgICAgICAgeUF4aXMzID0gZDMuYXhpc0xlZnQoeTMpO1xuXG4gICAgICAgICAgICB2YXIgYnJ1c2ggPSBkMy5icnVzaFgoKVxuICAgICAgICAgICAgICAuZXh0ZW50KFtcbiAgICAgICAgICAgICAgICBbMCwgMF0sXG4gICAgICAgICAgICAgICAgW3dpZHRoLCBoZWlnaHQyXVxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgICAub24oXCJicnVzaFwiLCBicnVzaGVkKTtcblxuICAgICAgICAgICAgc3ZnID0gZDMuc2VsZWN0KGVsZW1lbnRbMF0pLmFwcGVuZChcInN2Z1wiKVxuICAgICAgICAgICAgICAuYXR0cihcImlkXCIsIFwiSURcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aCArIG1hcmdpbi5sZWZ0ICsgbWFyZ2luLnJpZ2h0KVxuICAgICAgICAgICAgICAuYXR0cihcImhlaWdodFwiLCBoZWlnaHQgKyBtYXJnaW4udG9wICsgbWFyZ2luLmJvdHRvbSk7XG5cbiAgICAgICAgICAgIHN2Zy5hcHBlbmQoXCJkZWZzXCIpLmFwcGVuZChcImNsaXBQYXRoXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiaWRcIiwgXCJjbGlwXCIpXG4gICAgICAgICAgICAgIC5hcHBlbmQoXCJyZWN0XCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwid2lkdGhcIiwgd2lkdGgpXG4gICAgICAgICAgICAgIC5hdHRyKFwiaGVpZ2h0XCIsIGhlaWdodCk7XG5cbiAgICAgICAgICAgIHZhciBmb2N1cyA9IHN2Zy5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJmb2N1c1wiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZShcIiArIG1hcmdpbi5sZWZ0ICsgXCIsXCIgKyBtYXJnaW4udG9wICsgXCIpXCIpO1xuXG4gICAgICAgICAgICB2YXIgY29udGV4dCA9IHN2Zy5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJjb250ZXh0XCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgbWFyZ2luMi5sZWZ0ICsgXCIsXCIgKyBtYXJnaW4yLnRvcCArIFwiKVwiKTtcblxuICAgICAgICAgICAgdmFyIGZyZWcgPSBzdmcuYXBwZW5kKFwiZ1wiKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwiZnJlZ1wiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInRyYW5zbGF0ZShcIiArIG1hcmdpbjMubGVmdCArIFwiLFwiICsgbWFyZ2luMy50b3AgKyBcIilcIik7XG5cblxuXG5cbiAgICAgICAgICAgIHguZG9tYWluKGQzLmV4dGVudChkYXRhLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBkLkRhdGU7XG4gICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB5LmRvbWFpbihbZDMubWluKGRhdGEsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGQuTG93O1xuICAgICAgICAgICAgfSksIGQzLm1heChkYXRhLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBkLkhpZ2g7XG4gICAgICAgICAgICB9KV0pO1xuICAgICAgICAgICAgeDIuZG9tYWluKHguZG9tYWluKCkpO1xuICAgICAgICAgICAgeTIuZG9tYWluKHkuZG9tYWluKCkpO1xuICAgICAgICAgICAgLy94My5kb21haW4oeC5kb21haW4oKSk7XG4gICAgICAgICAgICB4My5kb21haW4oZGF0YS5tYXAoZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICByZXR1cm4gZC5EYXRlO1xuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICB5My5kb21haW4oeS5kb21haW4oKSk7XG5cblxuICAgICAgICAgICAgdmFyIGFyZWEgPSBkMy5hcmVhKClcbiAgICAgICAgICAgICAgLmN1cnZlKGQzLmN1cnZlTW9ub3RvbmVYKVxuICAgICAgICAgICAgICAueChmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHgoZC5EYXRlKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLnkwKGhlaWdodClcbiAgICAgICAgICAgICAgLnkxKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geShkLkNsb3NlKTtcbiAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGZvY3VzLmFwcGVuZChcInBhdGhcIilcbiAgICAgICAgICAgICAgLmRhdGEoW2RhdGFdKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwiYXJlYVwiKVxuICAgICAgICAgICAgICAuYXR0cihcImRcIiwgYXJlYSk7XG5cblxuICAgICAgICAgICAgLy8gYXBwZW5kIHNjYXR0ZXIgcGxvdCB0byBtYWluIGNoYXJ0IGFyZWFcbiAgICAgICAgICAgIHZhciBkb3RzID0gZm9jdXMuYXBwZW5kKFwiZ1wiKTtcbiAgICAgICAgICAgIGRvdHMuYXR0cihcImNsaXAtcGF0aFwiLCBcInVybCgjY2xpcClcIik7XG4gICAgICAgICAgICBkb3RzLnNlbGVjdEFsbChcImRvdFwiKVxuICAgICAgICAgICAgICAuZGF0YShkYXRhKVxuICAgICAgICAgICAgICAuZW50ZXIoKS5hcHBlbmQoXCJjaXJjbGVcIilcbiAgICAgICAgICAgICAgLmF0dHIoJ2NsYXNzJywgJ2RvdCcpXG4gICAgICAgICAgICAgIC5hdHRyKFwiclwiLCAzKVxuICAgICAgICAgICAgICAuc3R5bGUoXCJvcGFjaXR5XCIsIC41KVxuICAgICAgICAgICAgICAuYXR0cihcImN4XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geChkLkRhdGUpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAuYXR0cihcImN5XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geShkLkNsb3NlKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLm9uKCdtb3VzZW92ZXInLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgZDMuc2VsZWN0KHRoaXMpLmF0dHIoJ3InLCA3KTtcblxuICAgICAgICAgICAgICAgIHZhciBmb3JtYXRUaW1lID0gZDMudGltZUZvcm1hdChcIiVlICVCXCIpXG5cblxuICAgICAgICAgICAgICAgIGRpdi5odG1sKFxuICAgICAgICAgICAgICAgICAgICAnPHRhYmxlPicgKyAnPHRyPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyAnRGF0ZScgKyAnPC90ZD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgZm9ybWF0VGltZShkLkRhdGUpICsgJzwvdGQ+JyArICc8L3RyPicgKyAnPHRyPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyAnT3BlbicgKyAnPC90ZD4nICtcbiAgICAgICAgICAgICAgICAgICAgJzx0ZD4nICsgZC5PcGVuICsgJzwvdGQ+JyArICc8L3RyPicgKyAnPHRyPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyAnQ2xvc2UnICsgJzwvdGQ+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArIGQuQ2xvc2UgKyAnPC90ZD4nICsgJzwvdHI+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdIaWdoJyArICc8L3RkPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyBkLkhpZ2ggKyAnPC90ZD4nICsgJzwvdHI+JyArICc8dHI+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArICdMb3cnICsgJzwvdGQ+JyArXG4gICAgICAgICAgICAgICAgICAgICc8dGQ+JyArIGQuTG93ICsgJzwvdGQ+JyArICc8L3RyPicgKyAnPHRyPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyAnVm9sdW1lJyArICc8L3RkPicgK1xuICAgICAgICAgICAgICAgICAgICAnPHRkPicgKyBkLlZvbHVtZSArICc8L3RkPicgKyAnPC90cj4nICsgJzwvdGFibGU+J1xuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgLnN0eWxlKFwibGVmdFwiLCAoZDMuZXZlbnQucGFnZVgpICsgXCJweFwiKVxuICAgICAgICAgICAgICAgICAgLnN0eWxlKFwidG9wXCIsIChkMy5ldmVudC5wYWdlWSAtIHBhcnNlSW50KGRpdi5zdHlsZSgnaGVpZ2h0JyksIDEwKSkgKyBcInB4XCIpXG4gICAgICAgICAgICAgICAgICAudHJhbnNpdGlvbigpXG4gICAgICAgICAgICAgICAgICAuZHVyYXRpb24oMjAwKVxuICAgICAgICAgICAgICAgICAgLnN0eWxlKFwib3BhY2l0eVwiLCAuOSlcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLm9uKCdtb3VzZW91dCcsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICBkMy5zZWxlY3QodGhpcykuYXR0cigncicsIDMpO1xuICAgICAgICAgICAgICAgIGRpdi50cmFuc2l0aW9uKClcbiAgICAgICAgICAgICAgICAgIC5kdXJhdGlvbig1MDApXG4gICAgICAgICAgICAgICAgICAuc3R5bGUoXCJvcGFjaXR5XCIsIDApO1xuICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgZm9jdXMuYXBwZW5kKFwiZ1wiKVxuICAgICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIFwiYXhpcyBheGlzLS14XCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiZmlsbFwiLCBcIm5vbmVcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMCxcIiArIGhlaWdodCArIFwiKVwiKVxuICAgICAgICAgICAgICAuY2FsbCh4QXhpcyk7XG5cbiAgICAgICAgICAgIGZvY3VzLmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImF4aXMgYXhpcy0teVwiKVxuICAgICAgICAgICAgICAuY2FsbCh5QXhpcyk7XG5cbiAgICAgICAgICAgIGZvY3VzLmFwcGVuZChcInRleHRcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJyb3RhdGUoLTkwKVwiKVxuICAgICAgICAgICAgICAuYXR0cihcInlcIiwgMCAtIG1hcmdpbi5sZWZ0KVxuICAgICAgICAgICAgICAuYXR0cihcInhcIiwgMCAtIChoZWlnaHQgLyAyKSlcbiAgICAgICAgICAgICAgLmF0dHIoXCJkeVwiLCBcIjFlbVwiKVxuICAgICAgICAgICAgICAuc3R5bGUoXCJ0ZXh0LWFuY2hvclwiLCBcIm1pZGRsZVwiKVxuICAgICAgICAgICAgICAudGV4dChcIlByaWNlXCIpO1xuXG4gICAgICAgICAgICBzdmcuYXBwZW5kKFwidGV4dFwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLFxuICAgICAgICAgICAgICAgIFwidHJhbnNsYXRlKFwiICsgKCh3aWR0aCArIG1hcmdpbi5yaWdodCArIG1hcmdpbi5sZWZ0KSAvIDIpICsgXCIgLFwiICtcbiAgICAgICAgICAgICAgICBtYXJnaW4zLnRvcCArIFwiKVwiKVxuICAgICAgICAgICAgICAuc3R5bGUoXCJ0ZXh0LWFuY2hvclwiLCBcIm1pZGRsZVwiKVxuICAgICAgICAgICAgICAudGV4dChcIkRhdGVcIik7XG5cbiAgICAgICAgICAgIC8vIERlZmluZSB0aGUgZGl2IGZvciB0aGUgdG9vbHRpcFxuICAgICAgICAgICAgdmFyIGRpdiA9IGQzLnNlbGVjdChlbGVtZW50WzBdKS5hcHBlbmQoXCJkaXZcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcInRvb2x0aXBcIilcbiAgICAgICAgICAgICAgLnN0eWxlKFwib3BhY2l0eVwiLCAwKTtcblxuXG5cbiAgICAgICAgICAgIC8vIGFwcGVuZCBzY2F0dGVyIHBsb3QgdG8gYnJ1c2ggY2hhcnQgYXJlYVxuICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJheGlzIGF4aXMtLXhcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMCxcIiArIGhlaWdodDIgKyBcIilcIilcbiAgICAgICAgICAgICAgLmNhbGwoeEF4aXMyKTtcblxuICAgICAgICAgICAgY29udGV4dC5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJicnVzaFwiKVxuICAgICAgICAgICAgICAuY2FsbChicnVzaClcbiAgICAgICAgICAgICAgLmNhbGwoYnJ1c2gubW92ZSwgeC5yYW5nZSgpKTtcblxuICAgICAgICAgICAgdmFyIGFyZWEyID0gZDMuYXJlYSgpXG4gICAgICAgICAgICAgIC5jdXJ2ZShkMy5jdXJ2ZU1vbm90b25lWClcbiAgICAgICAgICAgICAgLngoZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHJldHVybiB4MihkLkRhdGUpO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAueTAoaGVpZ2h0MilcbiAgICAgICAgICAgICAgLnkxKGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geTIoZC5DbG9zZSk7XG4gICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBjb250ZXh0LmFwcGVuZChcInBhdGhcIilcbiAgICAgICAgICAgICAgLmRhdHVtKGRhdGEpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJhcmVhXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiZFwiLCBhcmVhMik7XG5cblxuICAgICAgICAgICAgZnJlZy5hcHBlbmQoXCJnXCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJheGlzIGF4aXMtLXhcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJ0cmFuc2xhdGUoMCxcIiArIGhlaWdodDMgKyBcIilcIilcbiAgICAgICAgICAgICAgLmNhbGwoeEF4aXMzKVxuICAgICAgICAgICAgICAuc2VsZWN0QWxsKFwidGV4dFwiKVxuICAgICAgICAgICAgICAuc3R5bGUoXCJ0ZXh0LWFuY2hvclwiLCBcImVuZFwiKVxuICAgICAgICAgICAgICAuYXR0cihcImR4XCIsIFwiLS44ZW1cIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJkeVwiLCBcIi0uNTVlbVwiKVxuICAgICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBcInJvdGF0ZSgtOTApXCIpO1xuXG4gICAgICAgICAgICBmcmVnLmFwcGVuZChcImdcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImF4aXMgYXhpcy0teVwiKVxuICAgICAgICAgICAgICAuY2FsbCh5QXhpczMpO1xuXG4gICAgICAgICAgICAvLyBBZGQgYSByZWN0IGZvciBlYWNoIGRhdGUuXG4gICAgICAgICAgICB2YXIgcmVjdCA9IGZyZWcuc2VsZWN0QWxsKFwicmVjdFwiKVxuICAgICAgICAgICAgICAuZGF0YShkYXRhKVxuICAgICAgICAgICAgICAuZW50ZXIoKS5hcHBlbmQoXCJyZWN0XCIpXG4gICAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJiYXJcIilcbiAgICAgICAgICAgICAgLmF0dHIoXCJ4XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geDMoZC5EYXRlKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmF0dHIoXCJ5XCIsIGZ1bmN0aW9uKGQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geTMoZC5IaWdoKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgLmF0dHIoXCJoZWlnaHRcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgIHkzKGQuSGlnaCk7XG4gICAgICAgICAgICAgICAgeTMoZC5Mb3cpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHkzKGQuTG93KSAtIHkzKGQuSGlnaCk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIC5hdHRyKFwid2lkdGhcIiwgeDMuYmFuZHdpZHRoKCkpO1xuXG5cblxuICAgICAgICAgICAgLy9jcmVhdGUgYnJ1c2ggZnVuY3Rpb24gcmVkcmF3IHNjYXR0ZXJwbG90IHdpdGggc2VsZWN0aW9uXG4gICAgICAgICAgICBmdW5jdGlvbiBicnVzaGVkKCkge1xuXG4gICAgICAgICAgICAgIGlmIChkMy5ldmVudC5zb3VyY2VFdmVudCAmJiBkMy5ldmVudC5zb3VyY2VFdmVudC50eXBlID09PSBcInpvb21cIikgcmV0dXJuOyAvLyBpZ25vcmUgYnJ1c2gtYnktem9vbVxuXG5cbiAgICAgICAgICAgICAgdmFyIHNlbGVjdGlvbiA9IGQzLmV2ZW50LnNlbGVjdGlvbjtcbiAgICAgICAgICAgICAgeC5kb21haW4oc2VsZWN0aW9uLm1hcCh4Mi5pbnZlcnQsIHgyKSk7XG4gICAgICAgICAgICAgIGZvY3VzLnNlbGVjdChcIi5hcmVhXCIpLmF0dHIoXCJkXCIsIGFyZWEpO1xuICAgICAgICAgICAgICBmb2N1cy5zZWxlY3RBbGwoXCIuZG90XCIpXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJjeFwiLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4geChkLkRhdGUpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJjeVwiLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgICByZXR1cm4geShkLkNsb3NlKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgZm9jdXMuc2VsZWN0KFwiLmF4aXMtLXhcIikuY2FsbCh4QXhpcyk7XG5cbiAgICAgICAgICAgICAgeDMuZG9tYWluKCk7XG5cblxuICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBzZWxlY3Rpb24ubWFwKHgyLmludmVydCwgeDIpO1xuXG4gICAgICAgICAgICAgIHgzLmRvbWFpbihkYXRhLm1hcChmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgaWYgKHJhbmdlWzBdIDw9IGQuRGF0ZSAmJiBkLkRhdGUgPD0gcmFuZ2VbMV0pXG4gICAgICAgICAgICAgICAgICByZXR1cm4gZC5EYXRlO1xuICAgICAgICAgICAgICB9KSk7XG5cblxuICAgICAgICAgICAgICBmcmVnLnNlbGVjdEFsbChcInJlY3RcIilcbiAgICAgICAgICAgICAgICAuYXR0cihcInhcIiwgZnVuY3Rpb24oZCkge1xuXG4gICAgICAgICAgICAgICAgICBpZiAocmFuZ2VbMF0gPD0gZC5EYXRlICYmIGQuRGF0ZSA8PSByYW5nZVsxXSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHgzKGQuRGF0ZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuYXR0cihcInlcIiwgZnVuY3Rpb24oZCkge1xuICAgICAgICAgICAgICAgICAgaWYgKHJhbmdlWzBdIDw9IGQuRGF0ZSAmJiBkLkRhdGUgPD0gcmFuZ2VbMV0pXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB5MyhkLkhpZ2gpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmF0dHIoJ2RhdGUnLCBmdW5jdGlvbihkKSB7XG4gICAgICAgICAgICAgICAgICBpZiAocmFuZ2VbMF0gPD0gZC5EYXRlICYmIGQuRGF0ZSA8PSByYW5nZVsxXSlcbiAgICAgICAgICAgICAgICAgIHJldHVybiBkLkRhdGU7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuYXR0cihcImhlaWdodFwiLCBmdW5jdGlvbihkKSB7XG5cbiAgICAgICAgICAgICAgICAgIHkzKGQuSGlnaCk7XG4gICAgICAgICAgICAgICAgICB5MyhkLkxvdyk7XG5cbiAgICAgICAgICAgICAgICAgIGlmIChyYW5nZVswXSA8PSBkLkRhdGUgJiYgZC5EYXRlIDw9IHJhbmdlWzFdKVxuICAgICAgICAgICAgICAgICAgcmV0dXJuIHkzKGQuTG93KSAtIHkzKGQuSGlnaCk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAuYXR0cihcIndpZHRoXCIsIHgzLmJhbmR3aWR0aCgpKTtcblxuICAgICAgICAgICAgICBmcmVnLnNlbGVjdChcIi5heGlzLS14XCIpLmNhbGwoeEF4aXMzKVxuICAgICAgICAgICAgICAgIC5zZWxlY3RBbGwoXCJ0ZXh0XCIpXG4gICAgICAgICAgICAgICAgLnRleHQoZnVuY3Rpb24oZCkge1xuXG4gICAgICAgICAgICAgICAgICBpZighIWQpe1xuICAgICAgICAgICAgICAgICAgIHZhciBmb3JtYXRUaW1lID0gZDMudGltZUZvcm1hdChcIiVtLSVkXCIpO1xuICAgICAgICAgICAgICAgICAgIHJldHVybiBmb3JtYXRUaW1lKGQpO1xuICAgICAgICAgICAgICAgICAgfX0pXG4gICAgICAgICAgICAgICAgLnN0eWxlKFwidGV4dC1hbmNob3JcIiwgXCJlbmRcIilcbiAgICAgICAgICAgICAgICAuYXR0cihcImR4XCIsIFwiLS44ZW1cIilcbiAgICAgICAgICAgICAgICAuYXR0cihcImR5XCIsIFwiLS41NWVtXCIpXG4gICAgICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgXCJyb3RhdGUoLTkwKVwiKTtcblxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgIH0pO1xuICAgIH1cblxuXG5cblxuXG5cblxuXG5cblxuXG5cbn1dKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
